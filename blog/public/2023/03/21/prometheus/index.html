<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Prometheus &middot; Vitor Lobo</title>
        <meta name="description" content="Under the hood">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.128.2">
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Prometheus">
<meta property="og:description" content="Under the hood">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:1313/2023/03/21/prometheus/">
        <link rel="stylesheet" href="http://localhost:1313//dist/site.css">
        <link rel="stylesheet" href="http://localhost:1313//dist/syntax.css">
        <link href="https://fonts.googleapis.com/css?family=Chilanka&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Roboto:wght@300;900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|PT+Sans+Caption:700,400|Source+Sans+Pro:400|Raleway:300" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        <link rel="shortcut icon" href="http://localhost:1313//img/favicon.ico">
    </head>
    <body>
        
  



        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="neurodev-title">
                                <a title="neurodev" href="http://localhost:1313/">$ /home/scovl_</a>
                            </h1>
                        
                        <a class="button-square" href="http://localhost:1313//index.xml"><i class="fa fa-rss"></i></a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/scovl" rel="me" target="_blank">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/vitor-lobo" rel="me" target="_blank">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" title="Email" href="mailto:lobocode@gmail.com">
                                <i class="fa fa-envelope"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        <a class="site-nav-item" title="Home" href="/">Home</a>

    <li class="site-nav-item">
        <a title="About" href="/page/about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Contact" href="/page/contact/">Contact</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Prometheus</h1>
    
        <p class="post-description" itemprop="description">Under the hood</p>
    
    <p class="post-date">
        <span>Published <time datetime="2023-03-21" itemprop="datePublished">ter., mar. 21, 2023</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://google.com/&#43;XXX" itemprop="url" rel="author">Vitor Lobo</a>
            </span>
        </span>
    </p>
    
        <p class="post-reading post-line">
            <span>Estimated reading time: 35 min</span>
        </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <ul>
<li><strong><a href="/2023/03/21/prometheus/#introdu√ß√£o">Introdu√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#instala√ß√£o">Instala√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#promtool">Promtool</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#instrumenta√ß√£o">Instrumenta√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#alertmanager">Alertmanager</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#pushgateway">PushGateway</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#federa√ß√£o">Federa√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#under-the-hood">Under the Hood</a></strong></li>
</ul>
<h2 id="introdu√ß√£o">Introdu√ß√£o</h2>
<h3 id="prometheus">Prometheus</h3>
<p>O Prometheus √© uma ferramenta de monitoramento de sistemas e aplicativos open source. Foi desenvolvida com o objetivo de fornecer uma forma eficiente de coletar, armazenar e analisar m√©tricas de desempenho de sistemas distribu√≠dos. Ele foi projetado para ser escal√°vel, f√°cil de usar e altamente personaliz√°vel. Possui sua pr√≥pria linguagem de consulta, chamada PromQL, que permite aos usu√°rios criar consultas complexas para analisar os dados de m√©tricas. Ele tamb√©m possui uma interface web para visualizar e explorar esses dados. Al√©m disso, √© compat√≠vel com uma variedade de sistemas e aplicativos, incluindo Kubernetes, Docker, e outros sistemas de gerenciamento de cont√™ineres. O Prometheus tamb√©m √© frequentemente usado em conjunto com outras ferramentas, como Grafana, que fornece recursos avan√ßados de visualiza√ß√£o de dados, alertas e an√°lise hist√≥rica de dados.</p>
<p>A ferramenta foi criada por uma equipe de desenvolvedores liderada por Julius Volz na empresa de consultoria de engenharia de software SoundCloud em 2012. No entanto, em 2016, a equipe do Prometheus foi transferida para a <strong><a href="https://www.cncf.io/">Cloud Native Computing Foundation (CNCF)</a></strong>, uma organiza√ß√£o sem fins lucrativos que abriga projetos de c√≥digo aberto para sistemas nativos da nuvem. Atualmente, a CNCF respons·vel pelo desenvolvimento e manutenÁ„o do projeto Prometheus.</p>
<blockquote>
<p><strong>NOTA</strong>: Leia mais sobre PromQL <strong><a href="https://scovl.github.io/2023/03/19/promql/">Aqui</a></strong>.</p>
</blockquote>
<h3 id="tipos-de-m√©tricas">Tipos de m√©tricas</h3>
<p>O Prometheus suporta quatro tipos principais de m√©tricas: Counter, Gauge, Histogram e Summary:</p>
<ul>
<li><strong>Counter:</strong> S√£o m√©tricas que representam um valor crescente ao longo do tempo, como o n√∫mero de solicita√ß√µes recebidas por um servidor. Os contadores nunca diminuem, exceto quando redefinidos manualmente. Por exemplo, voc√™ pode usar a fun√ß√£o <code>increase()</code> para calcular a taxa de incremento de um contador.</li>
<li><strong>Gauge</strong>: S√£o m√©tricas que representam um valor arbitr√°rio em um determinado momento, como o uso de CPU. Os valores dos indicadores podem aumentar ou diminuir ao longo do tempo e n√£o t√™m um valor m√≠nimo ou m√°ximo definido. As fun√ß√µes mais comuns para os indicadores s√£o <code>sum()</code>, <code>avg()</code> e <code>min()</code> e <code>max()</code>.</li>
<li><strong>Histogram:</strong> S√£o m√©tricas que calculam a distribui√ß√£o de valores em um intervalo de tempo, como o tempo de resposta de uma solicita√ß√£o de rede. Os histogramas s√£o calculados a partir de contadores, em que os valores dos contadores s√£o divididos em intervalos ou buckets de tamanho fixo. As fun√ß√µes <code>histogram_quantile()</code> e <code>irate()</code> s√£o frequentemente usadas para analisar histogramas.</li>
<li><strong>Summary</strong>: S√£o m√©tricas semelhantes a um histogram, mas em vez de contabilizar os valores dos contadores em baldes fixos, calcula a m√©dia, o percentil e o n√∫mero total de valores em um determinado per√≠odo. √â indicado para o c√°lculo de m√©dias, valores extremos e percentis.</li>
</ul>
<p>No geral histogramas s√£o mais eficientes para lat√™ncia e distribui√ß√£o de dados enquanto summaries s√£o mais precisos para percentis espec√≠ficos.</p>
<p>Al√©m desses tipos de m√©tricas, o Prometheus tamb√©m suporta m√©tricas de estado, que s√£o usadas para indicar se um determinado recurso est√° <code>up</code>,<code>down</code>. Essas m√©tricas s√£o geralmente usadas para monitorar a disponibilidade de servi√ßos.</p>
<h3 id="monitoramento-pull-vs-push">Monitoramento pull vs push</h3>
<p>Para simplificar o entendimento a cerca de monitoramento Pull vs Push, imagine que voc√™ tem um vaso de flores em sua janela. O monitoramento pull √© como voc√™ ir l√° todos os dias para verificar se as flores precisam de √°gua. Voc√™ est√° puxando informa√ß√µes sobre as flores. J√° o monitoramento push √© como se voc√™ tivesse um sistema autom√°tico que envia uma mensagem para voc√™ quando as flores precisam de √°gua. Neste caso, as informa√ß√µes est√£o sendo empurradas para voc√™. Tecnicamente, o monitoramento pull √© um m√©todo no qual um dispositivo ou sistema solicita periodicamente informa√ß√µes de outro dispositivo ou sistema. Ele &ldquo;puxa&rdquo; as informa√ß√µes. Por exemplo, em um sistema de monitoramento de rede, um dispositivo de monitoramento pode enviar uma solicita√ß√£o de status para cada dispositivo na rede a intervalos regulares e armazenar as informa√ß√µes retornadas.</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-pullvspush.png#center"></p>
<p>J√° o monitoramento push √© um m√©todo no qual um dispositivo ou sistema envia automaticamente informa√ß√µes para outro dispositivo ou sistema sem esperar uma solicita√ß√£o. Ele &ldquo;empurra&rdquo; as informa√ß√µes. Por exemplo, em um sistema de monitoramento de rede, cada dispositivo na rede pode ser configurado para automaticamente enviar informa√ß√µes de status para um dispositivo de monitoramento sempre que houver uma altera√ß√£o. Em resumo, o monitoramento pull √© baseado em solicita√ß√£o e o monitoramento push √© baseado em notifica√ß√£o. O Prometheus usa Exporters para expor dados de diversos sistemas e aplicativos, que o Prometheus coleta periodicamente (monitoramento pull). O Prometheus utiliza um mÈtodo de coleta &ldquo;pull&rdquo;, onde ele periodicamente solicita dados dos Exporters configurados. Isso permite que o Prometheus colete dados em tempo real e sem sobrecarregar os sistemas e aplicativos monitorados.</p>
<h3 id="arquitetura-do-prometheus">Arquitetura do Prometheus</h3>
<p>A arquitetura do Prometheus torna mais f√°cil encontrar e obter dados de diferentes pontos de acesso. O servidor Prometheus cuida da coleta e armazenamento das m√©tricas. Ele organiza as tarefas de monitoramento - consultando fontes de dados (conhecidas como &ldquo;inst√¢ncias&rdquo;) em intervalos de tempo predefinidos. As tarefas de monitoramento s√£o configuradas usando uma ou mais diretrizes chamadas &ldquo;configura√ß√µes de coleta&rdquo;, gerenciadas por um arquivo de configura√ß√£o em formato YAML. A imagem abaixo representa a arquitetura do Prometheus:</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/prometheus/arch.png#center"></p>
<p>O ecossistema do Prometheus √© composto por diversos componentes, muitos deles opcionais como por exemplo:</p>
<ul>
<li><strong>Servidor principal do Prometheus</strong>: √© respons√°vel por raspar (coletar) e armazenar dados de s√©ries temporais. Ele tamb√©m fornece uma interface de consulta para consultar esses dados.</li>
<li><strong>Bibliotecas cliente</strong>: s√£o usadas para adicionar instrumenta√ß√£o (m√©tricas) ao c√≥digo da aplica√ß√£o, facilitando a coleta de informa√ß√µes pelo Prometheus.</li>
<li><strong>Gateway de envio (Push Gateway)</strong>: permite o suporte a trabalhos de curta dura√ß√£o, j√° que o Prometheus utiliza um modelo de coleta &ldquo;pull&rdquo;. O gateway de envio recebe m√©tricas desses trabalhos e as armazena temporariamente at√© que o Prometheus as colete.</li>
<li><strong>Exportadores espec√≠ficos</strong>: s√£o programas que coletam m√©tricas de servi√ßos como HAProxy, StatsD, Graphite, entre outros, e as convertem para o formato compat√≠vel com o Prometheus. Isso facilita o monitoramento desses servi√ßos.</li>
<li><strong>Gerenciador de alertas (Alertmanager)</strong>: √© respons√°vel por tratar os alertas. O Prometheus avalia regras de alerta baseadas nas m√©tricas coletadas e envia notifica√ß√µes ao Alertmanager, que agrupa, silencia e encaminha esses alertas para os canais de notifica√ß√£o adequados, como e-mail, Slack ou PagerDuty.</li>
<li><strong>Ferramentas de suporte</strong>: incluem uma variedade de ferramentas que auxiliam no uso e gerenciamento do Prometheus, como pain√©is de visualiza√ß√£o de dados, ferramentas de linha de comando e utilit√°rios para an√°lise e depura√ß√£o.</li>
</ul>
<h3 id="labels-e-samples">Labels e Samples</h3>
<p>Labels s√£o como etiquetas que adicionamos √†s coisas para identific√°-las. Por exemplo, voc√™ tem um arm√°rio com camisetas e voc√™ coloca etiquetas nas camisetas com as cores, tamanhos e tipos delas. Ent√£o, se voc√™ quer pegar uma camiseta verde, voc√™ vai olhar na etiqueta e buscar uma camiseta verde. No Prometheus, labels s√£o usadas para identificar e agrupar diferentes dados de m√©tricas, assim como as etiquetas nas camisetas. Por exemplo, voc√™ tem v√°rios computadores e quer monitorar o uso de mem√≥ria de cada um deles. Voc√™ pode adicionar labels como &ldquo;hostname&rdquo; e &ldquo;sistema operacional&rdquo; para cada dado de m√©trica, ent√£o se voc√™ quiser saber o uso de mem√≥ria de um computador espec√≠fico, voc√™ pode buscar pela label &ldquo;hostname&rdquo; dele. J√° as Samples s√£o como pequenas amostras de algo. Por exemplo, voc√™ est√° fazendo uma pesquisa sobre quantas balas as crian√ßas gostam de comer e voc√™ pede para cada crian√ßa escolher uma amostra de 3 balas. Essas 3 balas que cada crian√ßa escolheu s√£o as samples. No Prometheus, samples s√£o pequenas medidas de algo que queremos monitorar, como por exemplo, a utiliza√ß√£o de CPU de um computador. Cada vez que coletamos uma medida, √© criado um sample. Esses samples s√£o armazenados juntos com labels, permitindo que voc√™ possa ver como a medida mudou ao longo do tempo. Por exemplo, voc√™ pode ver como a utiliza√ß√£o de CPU de um computador espec√≠fico mudou ao longo de um dia.</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/master/post/images/tsdb/samples01.png#center"></p>
<h2 id="instala√ß√£o">Instala√ß√£o</h2>
<p>Existem in√∫meras maneiras de instalar o Prometheus, mas aqui vamos mostrar como instalar o Prometheus usando o Docker e o Docker Compose, Grafana e o PromSim um simulador de m√©tricas para testar o Prometheus e Grafana. Crie um arquivo de configura√ß√£o do Docker Compose chamado <code>docker-compose.yml</code> no mesmo diret√≥rio que o arquivo prometheus.yml. Inclua as seguintes configura√ß√µes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">prom/prometheus:latest</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;9090:9090&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;./prometheus.yml:/etc/prometheus/prometheus.yml&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span>- <span class="l">promsim</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">grafana</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">grafana/grafana:latest</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">promsim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">sysdigtraining/promsim:latest</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">promsim</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Em seguida, crie um arquivo de configura√ß√£o do Prometheus chamado prometheus.yml no mesmo diret√≥rio que o arquivo docker-compose.yml. Inclua as seguintes configura√ß√µes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;promsim&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;promsim:8080&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>No terminal, navegue at√© o diret√≥rio onde voc√™ salvou o docker-compose.yml e execute o seguinte comando para iniciar os servi√ßos:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">docker-compose up -d
</span></span></code></pre></div><p>No Grafana, voc√™ precisar√° adicionar o Prometheus como uma fonte de dados (datasource). Fa√ßa login no Grafana (usu√°rio padr√£o: admin, senha: admin), v√° para &ldquo;Configuration&rdquo; (√≠cone de engrenagem) e clique em &ldquo;Data Sources&rdquo;. Adicione uma nova fonte de dados com o tipo Prometheus e use a URL <strong>http://prometheus:9090</strong>. Agora voc√™ pode criar pain√©is no Grafana usando m√©tricas do Prometheus e do PromSim. O PromSim ir√° gerar m√©tricas simuladas que voc√™ pode usar para testar o comportamento do threshold. O PromSim √© um simulador de m√©tricas que gera m√©tricas aleat√≥rias para testar o Prometheus. Para mais informa√ß√µes sobre o PromSim, consulte a documenta√ß√£o oficial em <strong><a href="https://github.com/dmitsh/promsim">https://github.com/dmitsh/promsim</a></strong>.</p>
<p>Se voc√™ quiser instalar somente o Prometheus, basta rodar <code>docker run -p 9090:9090 prom/prometheus</code>. Voc√™ pode acessar a interface web do Prometheus em <strong>http://localhost:9090</strong>. Para mais informa√ß√µes sobre como instalar o Prometheus, consulte a documenta√ß√£o oficial do Prometheus em <strong><a href="https://prometheus.io/docs/prometheus/latest/getting_started/">https://prometheus.io/docs/prometheus/latest/getting_started/</a></strong>.</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/master/post/images/tsdb/ui01.png#center"></p>
<p>A interface do Prometheus √© composta pelos seguintes menus:</p>
<ul>
<li><strong>Alerts</strong>: este menu exibe todos os alertas ativos e permite visualizar o hist√≥rico de alertas. Os alertas s√£o disparados quando uma determinada m√©trica ultrapassa um limite configurado.</li>
<li><strong>Graph</strong>: este menu permite criar e visualizar gr√°ficos de m√©tricas coletadas pelo Prometheus. O usu√°rio pode definir a escala do eixo X e Y, bem como personalizar a apar√™ncia do gr√°fico.</li>
<li><strong>Status</strong>: este menu exibe o status atual do Prometheus, incluindo informa√ß√µes sobre as m√©tricas coletadas, alertas ativos e configura√ß√µes do sistema.</li>
<li><strong>Help</strong>: este menu fornece informa√ß√µes √∫teis sobre o Prometheus, incluindo documenta√ß√£o, exemplos de consulta e informa√ß√µes de contato da equipe de suporte.</li>
<li><strong>Classic UI</strong>: este menu oferece uma interface alternativa para visualiza√ß√£o de m√©tricas, com recursos adicionais em compara√ß√£o com a interface padr√£o.</li>
</ul>
<p>Al√©m disso, a interface do Prometheus cont√©m as seguintes op√ß√µes:</p>
<ul>
<li><strong>Use local time</strong>: essa op√ß√£o permite que o usu√°rio visualize as m√©tricas em seu fuso hor√°rio local em vez do hor√°rio do servidor.</li>
<li><strong>Enable query history</strong>: essa op√ß√£o permite que o usu√°rio acesse o hist√≥rico de consultas que foram executadas anteriormente.</li>
<li><strong>Enable autocomplete</strong>: essa op√ß√£o permite que o usu√°rio obtenha sugest√µes de consulta enquanto digita no campo de consulta.</li>
<li><strong>Campo de consulta</strong>: este √© o campo onde o usu√°rio pode inserir consultas PromQL para recuperar m√©tricas espec√≠ficas.</li>
<li><strong>Campo Table e Graph</strong>: este campo permite que o usu√°rio selecione entre exibir o resultado da consulta como uma tabela ou um gr√°fico.</li>
<li><strong>Evaluation time</strong>: este campo permite que o usu√°rio especifique o per√≠odo de tempo para o qual as m√©tricas devem ser recuperadas pela consulta.</li>
</ul>
<h3 id="configura√ß√£o">Configura√ß√£o</h3>
<p>No geral a estrutura de diret√≥rios do Prometheus √© a seguinte:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">/opt/prometheus/
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">‚îú‚îÄ‚îÄ console_libraries/
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ prom.lib.js
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ react-16.8.3.production.min.js
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ ...
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">‚îú‚îÄ‚îÄ consoles/
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ index.html
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ queries_range.html
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ ...
</span></span><span class="line"><span class="ln">10</span><span class="cl">‚îú‚îÄ‚îÄ prometheus
</span></span><span class="line"><span class="ln">11</span><span class="cl">‚îú‚îÄ‚îÄ prometheus.yml
</span></span><span class="line"><span class="ln">12</span><span class="cl">‚îú‚îÄ‚îÄ promtool
</span></span><span class="line"><span class="ln">13</span><span class="cl">‚îî‚îÄ‚îÄ ...
</span></span></code></pre></div><p>Pode variar a depender da vers√£o, mas a estrutura acima √© a mais comum. Os arquivos <code>prometheus</code> e <code>promtool</code> s√£o os bin√°rios do Prometheus e do promtool, respectivamente. O diret√≥rio <code>console_libraries</code> cont√©m bibliotecas JavaScript que s√£o usadas para renderizar a interface do Prometheus. O diret√≥rio <code>consoles</code> cont√©m arquivos HTML que s√£o usados para renderizar a interface do Prometheus. O arquivo <code>prometheus.yaml</code> √© o arquivo onde s√£o definidas as configura√ß√µes de scrape (coleta) de m√©tricas dos alvos a serem monitorados, regras de alerta, entre outras configura√ß√µes. Um exemplo de arquivo prometheus.yaml default pode ser algo parecido com isso:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>Nesse exemplo, temos duas se√ß√µes no arquivo de configura√ß√£o:</p>
<ul>
<li><strong>global</strong>: define as configura√ß√µes globais do Prometheus, como a frequ√™ncia de coleta de m√©tricas (scrape_interval), que neste caso √© de 15 segundos.</li>
<li><strong>scrape_configs</strong>: define as configura√ß√µes de coleta de m√©tricas para os alvos a serem monitorados. Neste caso, temos apenas um job (trabalho) definido, chamado prometheus, que monitora o pr√≥prio servidor do Prometheus na porta 9090. Para adicionar um sistema gen√©rico ao prometheus.yaml, √© necess√°rio criar uma nova configura√ß√£o de scrape. Por exemplo, suponha que temos um sistema com a aplica√ß√£o web em execu√ß√£o na porta 8080. Podemos adicionar essa configura√ß√£o de scrape da seguinte forma:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;my-app&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;my-app:8080&#39;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>Neste exemplo, foi criado um novo job chamado <code>my-app</code> que monitora o sistema gen√©rico na porta <code>8080</code>. O <code>static_configs</code> define os alvos a serem monitorados, que neste caso √© o sistema <code>my-app</code> na porta <code>8080</code>. Caso voc√™ deseje adicionar uma ou mais m√°quinas, recomendo que fa√ßa isso apontando para arquivos externos <code>.json</code> ao Prometheus. Para tal, podemos utilizar o mecanismo de discovery de arquivos est√°ticos. O discovery de arquivos est√°ticos permite ao Prometheus carregar dinamicamente configura√ß√µes de scrape a partir de arquivos <code>.json</code> que cont√™m informa√ß√µes sobre os alvos a serem monitorados. Por exemplo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;my-app&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span>- <span class="nt">files</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span>- <span class="l">/path/to/targets.json</span><span class="w">
</span></span></span></code></pre></div><p>No exemplo acima, foi criado um novo job chamado <code>my-app</code>, que usar√° o discovery de arquivos est√°ticos para buscar os alvos a serem monitorados a partir do arquivo <code>/path/to/targets.json</code>. A se√ß√£o <code>file_sd_configs</code> define as configura√ß√µes para o discovery de arquivos est√°ticos, que neste caso √© apenas o arquivo targets.json. O arquivo targets.json deve estar no seguinte formato:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span>{<span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nt">&#34;labels&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">      </span><span class="nt">&#34;job&#34;: </span><span class="s2">&#34;my-app&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">      </span><span class="nt">&#34;env&#34;: </span><span class="s2">&#34;production&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">&#34;targets&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span><span class="s2">&#34;my-app1:8080&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="s2">&#34;my-app2:8080&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>Cada objeto tem uma chave labels que cont√©m um objeto com r√≥tulos adicionais para os alvos (neste exemplo, os r√≥tulos s√£o job e env), e uma chave targets que cont√©m uma lista de alvos a serem monitorados. O job my-app ter√° dois alvos a serem monitorados: my-app1:8080 e my-app2:8080. Esses alvos ter√£o os r√≥tulos job e env definidos como my-app e production, respectivamente.</p>
<p>Al√©m da configura√ß√£o de scrape (coleta) de dados, caso voc√™ deseje roda-lo em produ√ß√£o, √© importante atentar para as configura√ß√µes de parametros do service dele no systemd. Por exemplo, para o Prometheus, √© importante definir o par√¢metro <code>--storage.tsdb.retention.time</code> para um valor maior que 15 dias, para que os dados de m√©tricas sejam armazenados por um per√≠odo maior. Para isso, basta adicionar a seguinte linha no arquivo de configura√ß√£o do Prometheus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/opt/prometheus/prometheus --config.file<span class="o">=</span>/opt/prometheus/prometheus.yml --storage.tsdb.retention.time<span class="o">=</span>30d
</span></span></code></pre></div><blockquote>
<p><strong>NOTA</strong>: o valor 30d define que os dados de m√©tricas ser√£o armazenados por 30 dias. Voc√™ pode definir um valor maior ou menor, dependendo da sua necessidade.</p>
</blockquote>
<p>Existem outras configura√ß√µes interessantes tamb√©m. Para obter uma lista completa de par√¢metros, consulte a documenta√ß√£o oficial do Prometheus em <strong><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></strong>.</p>
<blockquote>
<p><strong>Observa√ß√£o</strong>: o discovery de arquivos est√°ticos √© apenas um dos v√°rios mecanismos de descoberta dispon√≠veis no Prometheus. Para obter uma lista completa de mecanismos de descoberta, consulte a documenta√ß√£o oficial do Prometheus.</p>
</blockquote>
<h2 id="promtool">Promtool</h2>
<p>O promtool √© uma ferramenta de linha de comando que fornece v√°rias funcionalidades para ajudar a verificar a sintaxe de arquivos de configura√ß√£o do Prometheus, como o arquivo prometheus.yaml. Para verificar a sintaxe de um arquivo de configura√ß√£o, basta executar o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">promtool check config /path/to/prometheus.yaml
</span></span></code></pre></div><p>O promtool tamb√©m permite validar a sintaxe das regras de alerta definidas no arquivo de configura√ß√£o do Prometheus. Para isso, basta usar o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">promtool check rules /path/to/prometheus.yaml
</span></span></code></pre></div><p>√â poss√≠vel tamb√©m validar a sintaxe dos arquivos de registro de m√©tricas antes de serem importados pelo Prometheus. Para isso, basta usar o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">promtool check metrics /path/to/metrics.json
</span></span></code></pre></div><p>Al√©m disso, podemos converter m√©tricas entre diferentes formatos, como JSON e texto simples. Por exemplo, para converter um arquivo de registro de m√©tricas de formato texto para formato JSON, use o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ promtool convert metrics --from<span class="o">=</span>txt --to<span class="o">=</span>json &lt;arquivo_de_registro_de_metricas&gt;
</span></span></code></pre></div><p>O promtool pode ser usado para validar a integridade do armazenamento de m√©tricas, ajudando a detectar problemas comuns, como blocos de registro corrompidos. Para isso, use o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">promtool tsdb check /path/to/data/dir
</span></span></code></pre></div><p>Essas s√£o apenas algumas das funcionalidades do promtool. Ele pode ser uma ferramenta muito √∫til para garantir a qualidade do seu ambiente de monitoramento com Prometheus.</p>
<h2 id="instrumenta√ß√£o">Instrumenta√ß√£o</h2>
<p>A instrumenta√ß√£o √© um processo crucial para coletar dados de desempenho e monitorar sistemas em tempo real. No contexto do Prometheus, existem dois tipos principais de instrumenta√ß√£o: direta e indireta.</p>
<ul>
<li>
<p><strong>A instrumenta√ß√£o direta</strong> envolve a coleta de m√©tricas diretamente de um aplicativo ou servi√ßo, usando bibliotecas ou frameworks espec√≠ficos. Isso permite que os desenvolvedores definam as m√©tricas que s√£o importantes para o seu aplicativo ou servi√ßo e coletem informa√ß√µes espec√≠ficas, como tempo de resposta de uma chamada de API ou a quantidade de mem√≥ria usada.</p>
</li>
<li>
<p><strong>A instrumenta√ß√£o indireta</strong> envolve a coleta de m√©tricas de sistemas de terceiros, como servidores de banco de dados ou balanceadores de carga. Isso pode ser feito usando plugins ou exporters que se comunicam com o sistema externo e traduzem as m√©tricas em um formato que o Prometheus possa entender.</p>
</li>
</ul>
<p>Ambos os tipos de instrumenta√ß√£o s√£o importantes para obter insights precisos e valiosos sobre o desempenho do sistema. A instrumenta√ß√£o direta fornece dados espec√≠ficos e granulares sobre o desempenho do aplicativo ou servi√ßo, enquanto a instrumenta√ß√£o indireta permite monitorar o sistema como um todo e identificar gargalos e problemas em componentes externos.</p>
<h3 id="instrumenta√ß√£o-indireta">Instrumenta√ß√£o indireta</h3>
<h3 id="exporters">Exporters</h3>
<p>O Prometheus √© compat√≠vel com uma variedade de sistemas e aplicativos, incluindo Kubernetes, Docker, e outros sistemas de gerenciamento de cont√™ineres. Para coletar m√©tricas de desempenho desses sistemas e aplicativos, voc√™ pode usar exporters, que s√£o projetados para coletar dados de m√©tricas de fontes espec√≠ficas, como sistemas operacionais, redes e aplicativos. Isso permite que os usu√°rios coletem m√©tricas de diferentes fontes e as analisem de forma integrada. O Prometheus possui uma s√©rie de exporters nativos, que s√£o projetados para coletar m√©tricas de desempenho de sistemas e aplicativos espec√≠ficos. Esses exporters s√£o projetados para serem f√°ceis de usar e integrar com o Prometheus. Al√©m disso, voc√™ pode usar exporters de terceiros para coletar m√©tricas de desempenho de sistemas e aplicativos espec√≠ficos. Para mais informa√ß√µes sobre exporters, consulte a documenta√ß√£o oficial do Prometheus em <strong><a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></strong>.</p>
<h3 id="linux">Linux</h3>
<p>O node_exporter √© um exporter para o Prometheus que permite coletar m√©tricas do sistema operacional Linux. Ele coleta informa√ß√µes sobre o uso de recursos como CPU, mem√≥ria, disco, rede, entre outros. Ele fornece uma interface HTTP para expor esses dados no formato de m√©tricas Prometheus, que podem ser coletadas pelo Prometheus Server e posteriormente visualizadas e analisadas. O node_exporter √© especialmente √∫til para monitorar hosts Linux e obter uma vis√£o geral do desempenho do sistema operacional.</p>
<p>Ele pode ser usado para monitorar a utiliza√ß√£o de recursos, identificar gargalos de desempenho, detectar problemas de sa√∫de e criar alertas baseados em m√©tricas espec√≠ficas. O node_exporter tamb√©m √© uma ferramenta popular para monitorar clusters Kubernetes, pois ele pode coletar informa√ß√µes sobre o uso de recursos dentro dos cont√™ineres, ajudando a identificar problemas de recursos e garantir a sa√∫de do cluster. Para mais informa√ß√µes sobre o node_exporter, consulte a documenta√ß√£o oficial do Prometheus em <strong><a href="https://prometheus.io/docs/guides/node-exporter/">https://prometheus.io/docs/guides/node-exporter/</a></strong>.</p>
<h3 id="windows">Windows</h3>
<p>O Windows_exporter √© um exporter para o Prometheus que permite coletar m√©tricas do sistema operacional Windows. Ele √© uma vers√£o espec√≠fica para o Windows do node_exporter. Ele coleta informa√ß√µes sobre o uso de recursos como CPU, mem√≥ria, disco, rede, entre outros. Ele fornece uma interface HTTP para expor esses dados no formato de m√©tricas Prometheus, que podem ser coletadas pelo Prometheus Server e posteriormente visualizadas e analisadas. Para mais informa√ß√µes sobre o Windows_exporter, consulte a documenta√ß√£o oficial do projeto em <strong><a href="https://github.com/prometheus-community/windows_exporter">https://github.com/prometheus-community/windows_exporter</a></strong>.</p>
<h3 id="blackbox">Blackbox</h3>
<p>O Blackbox Exporter √© um componente do Prometheus que permite monitorar servi√ßos externos a partir de uma perspectiva externa. Ele funciona realizando requisi√ß√µes <code>HTTP</code>, <code>TCP</code> e <code>ICMP</code> em endpoints espec√≠ficos, permitindo verificar se esses servi√ßos est√£o funcionando corretamente. Para mais informa√ß√µes sobre o Blackbox Exporter, consulte a documenta√ß√£o oficial do projeto em <strong><a href="https://github.com/prometheus/blackbox_exporter">https://github.com/prometheus/blackbox_exporter</a></strong>.</p>
<h3 id="instrumenta√ß√£o-direta">Instrumenta√ß√£o direta</h3>
<h3 id="java">Java</h3>
<p>A instrumenta√ß√£o direta no Prometheus usando Java envolve a adi√ß√£o de c√≥digo ao seu aplicativo Java para coletar e fornecer dados de m√©tricas ao Prometheus. Isso geralmente √© feito adicionando uma biblioteca de instrumenta√ß√£o ao seu aplicativo e configurando-a para se comunicar com o Prometheus. Existem v√°rias bibliotecas de instrumenta√ß√£o dispon√≠veis para coletar m√©tricas em aplicativos Java, como o <strong><a href="https://micrometer.io/">https://micrometer.io/</a></strong>. Aqui est√° um exemplo de como adicionar o &ldquo;Prometheus Java client&rdquo; ao seu aplicativo Java e configur√°-lo para coletar m√©tricas de tempo de resposta de uma rota espec√≠fica:</p>
<ol>
<li>Adicione as depend√™ncias Micrometer e Prometheus ao seu projeto. Voc√™ pode fazer isso no Maven ou Gradle, adicionando as seguintes linhas ao arquivo de configura√ß√£o:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.micrometer<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>micrometer-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="nt">&lt;version&gt;</span>1.6.6<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.micrometer<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nt">&lt;version&gt;</span>1.6.6<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>Crie um objeto MeterRegistry para registrar as m√©tricas. Voc√™ pode fazer isso criando uma inst√¢ncia de PrometheusMeterRegistry, que √© uma implementa√ß√£o do MeterRegistry para o Prometheus:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">MeterRegistry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PrometheusMeterRegistry</span><span class="p">(</span><span class="n">PrometheusConfig</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>Adicione contadores, temporizadores, etc. ao MeterRegistry para registrar as m√©tricas. Por exemplo, para criar um contador:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Counter</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registry</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&#34;nome_do_contador&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">counter</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>Exporte as m√©tricas para o Prometheus. Voc√™ pode fazer isso adicionando um PrometheusMeterRegistry ao seu servidor HTTP. Por exemplo, se voc√™ estiver usando o Spring Boot, pode adicionar o seguinte c√≥digo ao seu arquivo de configura√ß√£o:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">MeterRegistryCustomizer</span><span class="o">&lt;</span><span class="n">PrometheusMeterRegistry</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">prometheusRegistryCustomizer</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">        </span><span class="n">PrometheusProperties</span><span class="w"> </span><span class="n">prometheusProperties</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">CollectorRegistry</span><span class="w"> </span><span class="n">collectorRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CollectorRegistry</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JvmMemoryMetrics</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JvmGcMetrics</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ProcessorMetrics</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UptimeMetrics</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">JvmThreadMetrics</span><span class="p">().</span><span class="na">bindTo</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">ClassLoaderMetrics</span><span class="p">().</span><span class="na">bindTo</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">DiskSpaceMetrics</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)).</span><span class="na">bindTo</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">PrometheusMeterRegistry</span><span class="p">.</span><span class="na">prometheusRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collectorRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">JvmMicrometerPrometheusExporter</span><span class="p">(</span><span class="n">collectorRegistry</span><span class="p">).</span><span class="na">register</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Isso adiciona um PrometheusMeterRegistry ao seu aplicativo Spring Boot e registra as m√©tricas com o Prometheus. Verifique as m√©tricas no Prometheus. Voc√™ pode acessar as m√©tricas do seu aplicativo Java no Prometheus acessando a URL <strong><a href="https://seu_aplicativo:9090/metrics">https://seu_aplicativo:9090/metrics</a></strong>. As m√©tricas ser√£o exibidas no formato Prometheus, que voc√™ pode usar para criar gr√°ficos e alertas.</p>
<h3 id="javascriptnode">JavaScript/Node</h3>
<p>A instrumenta√ß√£o indireta no Prometheus usando Node envolve a adi√ß√£o de c√≥digo ao seu aplicativo Node.js para coletar e fornecer dados de m√©tricas ao Prometheus. Isso geralmente √© feito adicionando uma biblioteca de instrumenta√ß√£o ao seu aplicativo e configurando-a para se comunicar com o Prometheus. Existem v√°rias bibliotecas de instrumenta√ß√£o dispon√≠veis para coletar m√©tricas em aplicativos Node.js, como o &ldquo;prom-client&rdquo; ou o &ldquo;node-prom-bundle&rdquo;. Aqui est√° um exemplo de como adicionar o &ldquo;prom-client&rdquo; ao seu aplicativo Node.js e configur√°-lo para coletar m√©tricas de tempo de resposta de uma rota espec√≠fica:</p>
<p>Instale o &ldquo;prom-client&rdquo; usando o npm:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">prom</span><span class="o">-</span><span class="nx">client</span>
</span></span></code></pre></div><p>No c√≥digo da sua classe principal, importe a biblioteca e crie um objeto &ldquo;Counter&rdquo; para armazenar as m√©tricas de tempo de resposta:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="kr">const</span> <span class="nx">promClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;prom-client&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="kr">const</span> <span class="nx">responseTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">promClient</span><span class="p">.</span><span class="nx">Counter</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;myapp_response_time_seconds&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Response time in seconds&#39;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>Na rota espec√≠fica que voc√™ deseja monitorar, adicione c√≥digo para medir o tempo de resposta e atualizar o contador:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;/example&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="c1">// ... your code here ...
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span>    <span class="nx">responseTime</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span><span class="nx">route</span><span class="o">:</span> <span class="s1">&#39;example&#39;</span><span class="p">},</span> <span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">(</span><span class="nx">start</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>Inicie um servidor HTTP na porta 9091 para expor as m√©tricas:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">promClient</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">contentType</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">promClient</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">metrics</span><span class="p">());</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9091</span><span class="p">);</span>
</span></span></code></pre></div><p>Configure o Prometheus para &ldquo;scrape&rdquo; as m√©tricas no endere√ßo <strong>http://localhost:9091/metrics</strong></p>
<p>Dessa forma, voc√™ estar√° coletando e fornecendo dados de m√©tricas de tempo de resposta para o Prometheus, permitindo monitorar o desempenho da sua rota espec√≠fica. √â poss√≠vel adicionar mais m√©tricas como essa para monitorar outras partes do seu aplicativo, como o uso de CPU, mem√≥ria, n√∫mero de requisi√ß√µes e outros. Al√©m disso, √© importante notar que, al√©m de coletar m√©tricas, tamb√©m √© poss√≠vel criar alertas no Prometheus com base nas m√©tricas coletadas, permitindo que voc√™ seja notificado quando determinadas condi√ß√µes de m√©tricas forem atingidas. Isso pode ser feito criando regras de alerta no arquivo de configura√ß√£o do Prometheus, especificando quais m√©tricas devem ser monitoradas e quais condi√ß√µes devem ser atendidas para disparar o alerta. √â poss√≠vel tamb√©m usar outros sistemas como o Alertmanager para gerenciar esses alertas e notifica√ß√µes.</p>
<h3 id="python">Python</h3>
<p>A instrumenta√ß√£o indireta no Prometheus usando Python envolve a adi√ß√£o de c√≥digo ao seu aplicativo Python para coletar e fornecer dados de m√©tricas ao Prometheus. Isso geralmente √© feito adicionando uma biblioteca de instrumenta√ß√£o ao seu aplicativo e configurando-a para se comunicar com o Prometheus. Existem v√°rias bibliotecas de instrumenta√ß√£o dispon√≠veis para coletar m√©tricas em aplicativos Python, como o &ldquo;prometheus_client&rdquo; ou o &ldquo;py-prometheus-client&rdquo;. Aqui est√° um exemplo de como adicionar o &ldquo;prometheus_client&rdquo; ao seu aplicativo Python e configur√°-lo para coletar m√©tricas de tempo de resposta de uma rota espec√≠fica:</p>
<p>Instale o &ldquo;prometheus_client&rdquo; usando o pip:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">prometheus_client</span>
</span></span></code></pre></div><p>No c√≥digo da sua classe principal, importe a biblioteca e crie um objeto &ldquo;Counter&rdquo; para armazenar as m√©tricas de tempo de resposta:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">response_time</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;myapp_response_time_seconds&#39;</span><span class="p">,</span> <span class="s1">&#39;Response time in seconds&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Na rota espec√≠fica que voc√™ deseja monitorar, adicione c√≥digo para medir o tempo de resposta e atualizar o contador:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&#34;/example&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="c1"># ... your code here ...</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">    <span class="n">response_time</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">route</span><span class="o">=</span><span class="s1">&#39;example&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">    <span class="k">return</span> <span class="s2">&#34;Hello, World!&#34;</span>
</span></span></code></pre></div><p>Inicie o servidor de m√©tricas no seu aplicativo, geralmente na porta 9090:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">start_http_server</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="n">start_http_server</span><span class="p">(</span><span class="mi">9090</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div><p>Configure o Prometheus para &ldquo;scrape&rdquo; as m√©tricas no endere√ßo http://localhost:9090/metrics.</p>
<p>Dessa forma, voc√™ estar√° coletando e fornecendo dados de m√©tricas de tempo de resposta para o Prometheus, permitindo monitorar o desempenho da sua rota espec√≠fica. √â poss√≠vel adicionar mais m√©tricas como essa para monitorar outras partes do seu aplicativo, como o uso de CPU, mem√≥ria, n√∫mero de requisi√ß√µes e outros. Al√©m disso, √© importante notar que, al√©m de coletar m√©tricas, tamb√©m √© poss√≠vel criar alertas no Prometheus com base nas m√©tricas coletadas, permitindo que voc√™ seja notificado quando determinadas condi√ß√µes de m√©tricas forem atingidas. Isso pode ser feito criando regras de alerta no arquivo de configura√ß√£o do Prometheus, especificando quais m√©tricas devem ser monitoradas e quais condi√ß√µes devem ser atendidas para disparar o alerta.</p>
<h3 id="ferramentas-legadas-e-privadas">Ferramentas legadas e privadas</h3>
<p>Muitas vezes temos sistemas e servi√ßos legados ou ferramentas fechadas que n√£o
fornecem suas m√©tricas em um formato compat√≠vel com o Prometheus. Nesses casos,
existem algumas solu√ß√µes poss√≠veis para monitor√°-los com o Prometheus:</p>
<ul>
<li><strong>Bridge</strong>: outra op√ß√£o √© utilizar bridges, que s√£o programas que atuam como intermedi√°rios entre o Prometheus e as ferramentas legadas ou fechadas. O bridge coleta as m√©tricas da ferramenta em um formato n√£o compat√≠vel com o Prometheus e as converte para um formato compat√≠vel antes de disponibiliz√°-las para o Prometheus.</li>
<li><strong>Plugins</strong>: uma terceira op√ß√£o √© utilizar plugins, que s√£o programas que estendem as funcionalidades do Prometheus. Um plugin pode ser desenvolvido para coletar m√©tricas de uma ferramenta espec√≠fica e disponibiliz√°-las em um formato compat√≠vel com o Prometheus.</li>
</ul>
<h2 id="alertmanager">Alertmanager</h2>
<p>O Alertmanager √© uma ferramenta que trabalha em conjunto com o Prometheus para gerenciar alertas. Ele recebe alertas do Prometheus e os processa de acordo com regras configuradas pelo usu√°rio, como notifica√ß√µes por email, Slack, PagerDuty, entre outras. Basicamente ele funciona como um servidor HTTP que aguarda as notifica√ß√µes de alertas enviadas pelo Prometheus. Quando o Prometheus detecta uma condi√ß√£o de alerta, ele envia uma notifica√ß√£o ao Alertmanager, que ent√£o segue as regras de roteamento de alertas configuradas pelo usu√°rio para enviar notifica√ß√µes.</p>
<p>Para configurar o Alertmanager com o Prometheus, √© necess√°rio criar um arquivo de configura√ß√£o <code>alertmanager.yml</code> e especificar o endpoint do Alertmanager no arquivo de configura√ß√£o <code>prometheus.yml</code>. O arquivo <code>alertmanager.yml</code> cont√©m as regras de roteamento de alertas e configura√ß√µes de notifica√ß√£o, como os destinat√°rios e as plataformas de notifica√ß√£o. Para mais informa√ß√µes sobre como configurar o Alertmanager, consulte a documenta√ß√£o oficial em <a href="https://prometheus.io/docs/alerting/latest/configuration/">https://prometheus.io/docs/alerting/latest/configuration/</a>.</p>
<blockquote>
<p><strong>Observa√ß√£o</strong>: o Alertmanager n√£o √© um componente obrigat√≥rio do Prometheus. Ele √© uma ferramenta opcional que pode ser usada para gerenciar alertas. Se voc√™ n√£o precisar de alertas, n√£o precisa configurar o Alertmanager. Pretendo escrever um outro artigo dedicado ao Alertmanager, ent√£o fique ligado!</p>
</blockquote>
<h2 id="pushgateway">PushGateway</h2>
<p>PushGateway √© um componente adicional do Prometheus que permite que aplicativos e sistemas enviem dados de m√©tricas para o Prometheus sem precisar de um exporter ou client library. Ele funciona como uma &ldquo;ponte&rdquo; que recebe os dados enviados pelos aplicativos e os repassa para o Prometheus Server. O PushGateway √© √∫til em situa√ß√µes em que os aplicativos ou sistemas n√£o podem ser modificados para incluir suporte nativo ao Prometheus, ou quando os aplicativos s√£o tempor√°rios e n√£o precisam ser monitorados continuamente. Ele tamb√©m √© √∫til para coletar m√©tricas de scripts e tarefas cron. Ao mesmo tempo, √© importante notar que o <strong>PushGateway n√£o √© projetado para ser usado como solu√ß√£o de longo prazo para monitoramento</strong>, j√° que ele n√£o armazena dados por muito tempo e n√£o suporta a funcionalidade de alertas do Prometheus. Ele √© melhor usado em conjunto com outras ferramentas de monitoramento ou como uma solu√ß√£o tempor√°ria.</p>
<h2 id="federa√ß√£o">Federa√ß√£o</h2>
<p>A Federa√ß√£o no Prometheus √© um recurso que permite que v√°rias inst√¢ncias do Prometheus sejam agrupadas e gerenciadas como uma √∫nica inst√¢ncia. Isso √© √∫til quando voc√™ tem v√°rios sistemas ou aplicativos que precisam ser monitorados, mas quer gerenciar esses dados de m√©tricas de forma centralizada. A Federa√ß√£o funciona criando uma hierarquia de inst√¢ncias do Prometheus, onde cada inst√¢ncia √© chamada de &ldquo;federada&rdquo; ou &ldquo;filha&rdquo; e uma inst√¢ncia √© chamada de &ldquo;federadora&rdquo; ou &ldquo;pai&rdquo;. A inst√¢ncia &ldquo;federadora&rdquo; √© respons√°vel por coletar dados de m√©tricas de todas as inst√¢ncias &ldquo;federadas&rdquo; e agrup√°-los em um √∫nico local. No entanto, em alguns casos, o uso da Federa√ß√£o pode causar problemas. Abaixo uma melhor explica√ß√£o sobre estes pontos:</p>
<ul>
<li><strong>Grande volume de dados</strong>: Se voc√™ estiver lidando com um grande volume de dados, a Federa√ß√£o pode sobrecarregar a inst√¢ncia central do Prometheus, j√° que todas as m√©tricas s√£o coletadas de v√°rias inst√¢ncias e armazenadas na inst√¢ncia central. Isso pode levar a problemas de desempenho e lat√™ncia.</li>
<li><strong>Aumento da complexidade</strong>: A configura√ß√£o e manuten√ß√£o de uma estrutura federada pode ser complexa, especialmente se voc√™ tiver v√°rias inst√¢ncias do Prometheus e hierarquias diferentes. Isso pode tornar a solu√ß√£o dif√≠cil de gerenciar e manter, aumentando a chance de erros e problemas de configura√ß√£o.</li>
<li><strong>Depend√™ncia de rede</strong>: A Federa√ß√£o exige uma conex√£o de rede est√°vel e confi√°vel entre as inst√¢ncias do Prometheus. Se a rede entre as inst√¢ncias for inst√°vel ou lenta, a coleta e consolida√ß√£o das m√©tricas pode ser afetada, causando atrasos ou perda de dados.</li>
<li><strong>Escalabilidade limitada</strong>: A Federa√ß√£o pode n√£o ser a melhor op√ß√£o para ambientes de grande escala, com muitos servi√ßos e inst√¢ncias do Prometheus. Nesse cen√°rio, a inst√¢ncia central pode se tornar um gargalo e limitar a escalabilidade geral do sistema de monitoramento.</li>
<li><strong>Seguran√ßa</strong>: A Federa√ß√£o requer que as inst√¢ncias do Prometheus se comuniquem entre si e compartilhem dados. Isso pode aumentar a superf√≠cie de ataque e potencialmente expor informa√ß√µes sens√≠veis, caso as medidas adequadas de seguran√ßa n√£o sejam implementadas.</li>
</ul>
<blockquote>
<p><strong>NOTA</strong>: Em um outro artigo pretendo escrever sobre como resolver o problema de federa√ß√£o potencializando o Prometheus com outras t√©cnologias, fique ligado!</p>
</blockquote>
<h2 id="under-the-hood">Under the Hood</h2>
<p>A pasta raiz do Prometheus cont√©m v√°rios arquivos de configura√ß√£o e dados. Os arquivos mais comuns incluem:</p>
<ul>
<li><strong>prometheus.yml:</strong> Este √© o arquivo de configura√ß√£o principal do Prometheus. Ele cont√©m configura√ß√µes como endere√ßos de coleta de dados, regras de alerta e configura√ß√µes de armazenamento.</li>
<li><strong>alert.rules:</strong> Este arquivo cont√©m regras de alerta que o Prometheus usa para gerar alertas quando as m√©tricas atenderem a certas condi√ß√µes.</li>
<li><strong>scrape_configs:</strong> Este arquivo cont√©m configura√ß√µes de coleta de dados que o Prometheus usa para coletar m√©tricas de diferentes fontes.</li>
<li><strong>rules.yml:</strong> Este arquivo cont√©m as regras de processamento de m√©tricas do Prometheus. Ele especifica como o Prometheus deve processar as m√©tricas coletadas.</li>
<li><strong>data:</strong> Esta pasta cont√©m os dados de m√©tricas coletadas pelo Prometheus. Isso inclui arquivos como o banco de dados de m√©tricas e arquivos de registro.</li>
</ul>
<p>Al√©m desses arquivos, a pasta raiz do Prometheus tamb√©m pode conter outros arquivos de configura√ß√£o e dados, dependendo da configura√ß√£o do Prometheus.  A pasta <strong>/data</strong> no Prometheus √© usada para armazenar todos os dados coletados pelo Prometheus. Ela cont√©m v√°rias pastas, como <strong>WAL, chunks_head,</strong> que s√£o usadas para armazenar diferentes tipos de dados. Exemplo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">./data
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">‚îú‚îÄ‚îÄ 01BKGV7JBM69T2G1BGBGM6KB12
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ meta.json
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">‚îú‚îÄ‚îÄ 01BKGTZQ1SYQJTR4PB43C8PD98
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ chunks
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="m">000001</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ tombstones
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ index
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ meta.json
</span></span><span class="line"><span class="ln">10</span><span class="cl">‚îú‚îÄ‚îÄ 01BKGTZQ1HHWHV8FBJXW1Y3W0K
</span></span><span class="line"><span class="ln">11</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ meta.json
</span></span><span class="line"><span class="ln">12</span><span class="cl">‚îú‚îÄ‚îÄ 01BKGV7JC0RY8A6MACW02A2PJD
</span></span><span class="line"><span class="ln">13</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ chunks
</span></span><span class="line"><span class="ln">14</span><span class="cl">‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="m">000001</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ tombstones
</span></span><span class="line"><span class="ln">16</span><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ index
</span></span><span class="line"><span class="ln">17</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ meta.json
</span></span><span class="line"><span class="ln">18</span><span class="cl">‚îú‚îÄ‚îÄ chunks_head
</span></span><span class="line"><span class="ln">19</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ <span class="m">000001</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">‚îî‚îÄ‚îÄ wal
</span></span><span class="line"><span class="ln">21</span><span class="cl">    ‚îú‚îÄ‚îÄ <span class="m">000000002</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    ‚îî‚îÄ‚îÄ checkpoint.00000001
</span></span><span class="line"><span class="ln">23</span><span class="cl">        ‚îî‚îÄ‚îÄ <span class="m">00000000</span>
</span></span></code></pre></div><ul>
<li><strong>WAL</strong> - (Write Ahead Log) √© o arquivo de log onde o Prometheus escreve todas as atualiza√ß√µes de dados antes de atualizar o banco de dados principal. Ele √© usado para garantir a consist√™ncia e recupera√ß√£o dos dados armazenados pelo Prometheus. Abaixo est√° um exemplo de como os dados s√£o armazenados no WAL:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">prometheus
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">‚îî‚îÄ‚îÄ wal
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    ‚îú‚îÄ‚îÄ <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ index
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ segments
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ tombstones
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    ‚îÇ   ‚îî‚îÄ‚îÄ wal
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    ‚îú‚îÄ‚îÄ <span class="m">1</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ index
</span></span><span class="line"><span class="ln">10</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ segments
</span></span><span class="line"><span class="ln">11</span><span class="cl">    ‚îÇ   ‚îú‚îÄ‚îÄ tombstones
</span></span><span class="line"><span class="ln">12</span><span class="cl">    ‚îÇ   ‚îî‚îÄ‚îÄ wal
</span></span><span class="line"><span class="ln">13</span><span class="cl">    ‚îî‚îÄ‚îÄ ...
</span></span></code></pre></div><p>Para simplificar ainda mais, imagine que o Prometheus √© um cofre, e dentro dele temos muitas coisas importantes, como n√∫meros e informa√ß√µes sobre o seu computador ou at√© mesmo sobre sua casa. Agora, imagine que toda vez que voc√™ adiciona algo novo no seu cofre, como por exemplo, a temperatura da sua casa, √© preciso escrever esse novo n√∫mero em um di√°rio, para sempre ter registro dele e poder acess√°-lo depois. Esse di√°rio √© o que chamamos de WAL (Write Ahead Log) do Prometheus. Ele √© como um di√°rio onde o Prometheus escreve tudo o que ele coleta e guarda essas informa√ß√µes, para que possamos acess√°-las depois. Assim como o di√°rio precisa ser guardado em algum lugar seguro, o WAL tamb√©m precisa ser guardado em um lugar seguro, para que n√£o possa ser perdido ou danificado. Isso garante que todas as informa√ß√µes importantes sejam sempre salvas e possam ser acessadas quando precisarmos delas.</p>
<ul>
<li><strong>chunks_head</strong> - √© a pasta onde o Prometheus armazena os principais dados de m√©tricas coletadas. Ela cont√©m pastas com nomes num√©ricos, cada uma corresponde a uma s√©rie de m√©tricas. Dentro de cada pasta, encontra-se outras pastas como chunks, tombstones e arquivos como meta.json e index.</li>
<li><strong>chunks</strong> - √© a pasta onde o Prometheus armazena os dados de m√©tricas coletadas em um formato compactado. Cada arquivo dentro dessa pasta representa um per√≠odo de tempo espec√≠fico.</li>
<li><strong>tombstones</strong> - √© a pasta onde o Prometheus armazena informa√ß√µes sobre m√©tricas que foram removidas do banco de dados. Isso √© usado para garantir que essas m√©tricas n√£o sejam inclu√≠das na recupera√ß√£o do banco de dados.</li>
<li><strong>meta.json</strong> - √© um arquivo que cont√©m informa√ß√µes sobre a s√©rie de m√©tricas, incluindo o nome, labels e outras informa√ß√µes relevantes.</li>
<li><strong>index</strong> - √© um arquivo que cont√©m um √≠ndice dos dados de m√©tricas armazenados no banco de dados. Isso √© usado para permitir que o Prometheus localize rapidamente os dados desejados.</li>
</ul>
<p>Tomando a pasta <strong>01BKGTZQ1SYQJTR4PB43C8PD98</strong> como exemplo, que √© um ID de bloco, observe que existe a seguinte estrutura:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">‚îú‚îÄ‚îÄ chunks
</span></span><span class="line"><span class="ln">2</span><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ <span class="m">000001</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">‚îú‚îÄ‚îÄ tombstones
</span></span><span class="line"><span class="ln">4</span><span class="cl">‚îú‚îÄ‚îÄ index
</span></span><span class="line"><span class="ln">5</span><span class="cl">‚îî‚îÄ‚îÄ meta.json
</span></span></code></pre></div><p>O arquivo meta.json √© usado para armazenar metadados dos s√©ries de dados que o Prometheus est√° rastreando. Ele cont√©m informa√ß√µes como o nome do arquivo e o intervalo de tempo dos dados armazenados, bem como outras informa√ß√µes relevantes para o funcionamento interno do Prometheus. Os itens espec√≠ficos dentro do arquivo meta.json podem variar dependendo da configura√ß√£o espec√≠fica do Prometheus e do tipo de s√©rie de dados que est√° sendo rastreada. Vamos aos detalhes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="s2">&#34;ulid&#34;</span>: <span class="s2">&#34;01BKGTZQ1SYQJTR4PB43C8PD98&#34;</span>,
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="s2">&#34;minTime&#34;</span>: 1602237600000,
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="s2">&#34;maxTime&#34;</span>: 1602244800000,
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="s2">&#34;stats&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="s2">&#34;numSamples&#34;</span>: 553673232,
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="s2">&#34;numSeries&#34;</span>: 1346066,
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;numChunks&#34;</span>: <span class="m">4440437</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="s2">&#34;compaction&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="s2">&#34;level&#34;</span>: 1,
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="s2">&#34;sources&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">            <span class="s2">&#34;01EM65SHSX4VARXBBHBF0M0FDS&#34;</span>,
</span></span><span class="line"><span class="ln">14</span><span class="cl">            <span class="s2">&#34;01EM6GAJSYWSQQRDY782EA5ZPN&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="o">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="s2">&#34;version&#34;</span>: <span class="m">1</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><ul>
<li><strong>ulid:</strong> √© um identificador √∫nico gerado para cada arquivo meta.json. √â usado para identificar de forma √∫nica cada s√©rie de dados armazenada pelo Prometheus.</li>
<li><strong>minTime e maxTime:</strong> s√£o os intervalos de tempo de in√≠cio e fim dos dados armazenados no arquivo meta.json. Eles s√£o usados para determinar o per√≠odo de tempo para o qual os dados armazenados no arquivo s√£o v√°lidos.</li>
<li><strong>stats:</strong> √© um objeto que cont√©m estat√≠sticas sobre o uso de mem√≥ria do arquivo meta.json, incluindo o tamanho do arquivo, o n√∫mero de s√©ries de dados armazenadas e o n√∫mero de amostras de dados.</li>
<li><strong>numSamples:</strong> √© o n√∫mero de amostras de dados armazenadas no arquivo meta.json.</li>
<li><strong>numSeries:</strong> √© o n√∫mero de s√©ries de dados armazenadas no arquivo meta.json.</li>
<li><strong>numChunks:</strong> √© o n√∫mero de chunks de dados (grupos de amostras de dados) armazenados no arquivo meta.json.</li>
<li><strong>compaction:</strong> √© um objeto que cont√©m informa√ß√µes sobre a compacta√ß√£o dos dados armazenados no arquivo meta.json.</li>
<li><strong>level:</strong> √© o n√≠vel de compacta√ß√£o dos dados armazenados no arquivo meta.json.</li>
<li><strong>sources:</strong> √© um array que cont√©m informa√ß√µes sobre as fontes dos dados armazenados no arquivo meta.json.</li>
<li><strong>version:</strong> √© a vers√£o do arquivo meta.json. √â usado para garantir compatibilidade com vers√µes futuras do Prometheus.</li>
</ul>
<p>A pasta &ldquo;chunks&rdquo; dentro da pasta 01BKGTZQ1SYQJTR4PB43C8PD98 dentro do diret√≥rio /data do Prometheus √© usada para armazenar os chunks de dados (grupos de amostras de dados) para cada s√©rie de dados que o Prometheus est√° rastreando. Cada arquivo dentro dessa pasta representa um chunk de dados √∫nico, e o nome do arquivo cont√©m informa√ß√µes sobre o intervalo de tempo e a s√©rie de dados a qual ele pertence. Os arquivos de chunks s√£o gerados pelo processo de compacta√ß√£o do Prometheus. Eles s√£o criados quando o Prometheus precisa remover dados antigos para liberar espa√ßo e continuar coletando novos dados.</p>
<p>Esses chunks s√£o usados para a recupera√ß√£o dos dados e para realizar consultas no futuro. Os arquivos contidos dentro dessa pasta s√£o codificados e compactados de forma a ocupar menos espa√ßo e s√£o lidos pelo Prometheus para responder consultas e exibir gr√°ficos. J√° o arquivo index, cont√©m o √≠ndice dos chunks de dados armazenados na pasta &ldquo;chunks&rdquo; da mesma pasta. O √≠ndice √© usado para permitir que o Prometheus r√°pida e eficientemente localize os chunks de dados relevantes para uma consulta espec√≠fica. Esse arquivo cont√©m informa√ß√µes sobre as s√©ries de dados, o intervalo de tempo dos dados, o nome do arquivo de chunk correspondente, e outras informa√ß√µes relevantes. O Prometheus usa essas informa√ß√µes para saber onde procurar os dados quando uma consulta √© realizada, permitindo que ele responda rapidamente.</p>
<h3 id="gerenciamento-de-mem√≥ria-pelo-prometheus">Gerenciamento de mem√≥ria pelo Prometheus</h3>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem01.png#center">
<!-- raw HTML omitted --><!-- raw HTML omitted -->Imagem 1.1<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>A imagem 1.1 acima representa o Prometheus quando usa muita mem√≥ria RAM e mem√≥ria em disco devido a natureza dos dados que ele coleta e armazena. Como ele armazena m√©tricas de forma temporal (time series), ele precisa manter uma grande quantidade de dados em mem√≥ria para que essas m√©tricas possam ser consultadas rapidamente. Isso √© especialmente importante quando ele precisa responder a consultas de alertas ou gr√°ficos em tempo real. Al√©m disso, Prometheus usa uma estrat√©gia de sliding window para descartar m√©tricas antigas que j√° n√£o s√£o consideradas relevantes. Isso significa que ele precisa manter uma grande quantidade de dados em mem√≥ria para garantir que as m√©tricas mais recentes possam ser acessadas rapidamente. Por outro lado, Prometheus usa muita mem√≥ria em disco para armazenar esses dados de forma persistente, o que permite que os dados sejam recuperados mesmo depois de um rein√≠cio do sistema. Isso tamb√©m permite que os dados sejam consultados novamente em um momento posterior, mesmo que n√£o estejam mais dispon√≠veis na mem√≥ria. O Prometheus precisa de uma grande quantidade de mem√≥ria RAM e mem√≥ria em disco para garantir que os dados possam ser coletados, armazenados e consultados de forma eficiente e r√°pida.</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem02.png#center">
<!-- raw HTML omitted --><!-- raw HTML omitted -->Imagem 1.2<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>Como bem mostra a Imagem 1.2 acima, quanto mais dias de dados s√£o armazenados, mais mem√≥ria e espa√ßo em disco ser√£o necess√°rios para armazen√°-los. Isso pode levar a problemas de performance, pois aumenta a quantidade de dados que precisam ser carregados e processados para responder a consultas. Al√©m disso, como os dados antigos tendem a ser menos relevantes, isso pode levar a problemas de escalabilidade, pois os dados antigos podem acabar consumindo muitos recursos de armazenamento e processamento, dificultando a capacidade de Prometheus de lidar com novos dados. Al√©m disso, √© importante considerar que o objetivo do Prometheus √© fornecer uma vis√£o em tempo real do sistema, ent√£o manter muitos dias de dados pode n√£o ser t√£o √∫til para detectar problemas recentes ou tend√™ncias atuais no sistema, e pode acabar fazendo com que os dados relevantes sejam enterrados em meio a grande quantidade de dados antigos. Por essas raz√µes, √© recomendado manter apenas uma quantidade de dias de dados que seja suficiente para as necessidades de monitoramento do seu sistema, e n√£o mais do que isso. √â poss√≠vel configurar o Prometheus para descartar dados antigos de acordo com a necessidade, e tamb√©m √© poss√≠vel armazenar os dados hist√≥ricos em outro sistema de armazenamento para an√°lise futura.</p>
<p><img alt="img#center" src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem03.png#center">
<!-- raw HTML omitted --><!-- raw HTML omitted -->Imagem 1.3<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>Como mostra na Imagem 1.3 acima, o Prometheus utiliza a mem√≥ria principal do host Linux para armazenar todas as m√©tricas coletadas. Essas m√©tricas s√£o mantidas em mem√≥ria para permitir uma consulta r√°pida e eficiente pelos usu√°rios. Nesse processo √© usado o modelo de coleta ativa, ou seja, √© responsabilidade do pr√≥prio Prometheus coletar as m√©tricas dos servi√ßos e aplicativos em execu√ß√£o. Isso significa que o Prometheus precisa gerenciar as m√©tricas de cada alvo e garantir que elas estejam dispon√≠veis para consulta. Para manter as m√©tricas em mem√≥ria, o Prometheus utiliza um buffer de grava√ß√£o em disco para evitar perda de dados. Quando a mem√≥ria RAM fica cheia, as m√©tricas mais antigas s√£o gravadas no buffer de grava√ß√£o em disco. Esse buffer √© dimensionado automaticamente de acordo com a quantidade de m√©tricas que o Prometheus est√° coletando. Quando o buffer de grava√ß√£o em disco est√° cheio, o Prometheus come√ßa a descartar as m√©tricas mais antigas, garantindo que as mais recentes estejam sempre dispon√≠veis. Al√©m disso, o Prometheus tamb√©m utiliza o swap do host para armazenar parte das m√©tricas caso a mem√≥ria RAM esteja completamente cheia.</p>
<p>No que diz respeito √† pilha do Prometheus, o sistema utiliza uma estrutura de dados chamada heap para armazenar as m√©tricas. A heap √© uma √°rea de mem√≥ria din√¢mica onde as m√©tricas s√£o alocadas e liberadas durante a execu√ß√£o do Prometheus. O gerenciamento da heap √© feito automaticamente pelo sistema operacional. Quando o Prometheus executa consultas, ele carrega todos os dados hist√≥ricos em mem√≥ria para processamento. Portanto, quanto mais tempo de dados hist√≥ricos, mais mem√≥ria √© consumida. Para gerenciar esse problema, √© importante definir pol√≠ticas de reten√ß√£o de dados sensatas para reduzir o tamanho dos dados armazenados no Prometheus. Tamb√©m √© importante monitorar o uso de mem√≥ria do servidor e ajustar as configura√ß√µes do Prometheus, como a frequ√™ncia de coleta de dados, para otimizar o uso da mem√≥ria.</p>
<p>Al√©m disso, pode ser necess√°rio considerar o dimensionamento vertical ou horizontal do servidor para lidar com grandes volumes de dados. J√° que o gerenciamento de mem√≥ria do Prometheus √© feito pelo sistema operacional, n√£o h√° muito o que possamos fazer para otimizar o uso de mem√≥ria, o recomendado √© potencializar o prometheus de modo que ele se torne apenas um componente de um sistema de monitoramento mais robusto, como √© o caso do Thanos, Victoriametrics, Cortex, etc. Mas esse √© um papo para outro artigo.</p>
<h2 id="conclus√£o">Conclus√£o</h2>
<p>Neste artigo, vimos como o Prometheus funciona e como ele coleta e armazena dados de m√©tricas. Tamb√©m vimos como o Prometheus funciona internamente, como ele armazena dados em mem√≥ria e em disco, e como ele gerencia a mem√≥ria do host Linux. Espero que voc√™ tenha gostado do artigo e que ele tenha ajudado voc√™ a entender melhor como o Prometheus</p>
<hr>
<h2 id="refer√™ncias">Refer√™ncias</h2>
<ul>
<li><strong><a href="https://prometheus.io/docs/introduction/overview/">Documenta√ß√£o Oficial</a></strong></li>
<li><strong><a href="https://www.robustperception.io/blog/">Site da RobustPerception</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/prometheus-up/9781492034131/">Prometheus Up and Running</a></strong></li>
<li><strong><a href="https://www.prometheusbook.com/">Prometheusbook de James Turnbull</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/hands-on-infrastructure-monitoring/9781789612349/">Hands-On Infrastructure Monitoring with Prometheus</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/monitoring-microservices-and/9781484262160/">Monitoring Microservices and Containerized Applications</a></strong></li>
</ul>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/prometheus/">Prometheus</a>, 
            
                <a href="/tags/grafana/">Grafana</a>, 
            
                <a href="/tags/monitoring/">Monitoring</a>, 
            
                <a href="/tags/tsdb/">TSDB</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Prometheus&url=http%3a%2f%2flocalhost%3a1313%2f2023%2f03%2f21%2fprometheus%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2f2023%2f03%2f21%2fprometheus%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=http%3a%2f%2flocalhost%3a1313%2f2023%2f03%2f21%2fprometheus%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
            <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Prometheus&url=http%3a%2f%2flocalhost%3a1313%2f2023%2f03%2f21%2fprometheus%2f&summary=Under%20the%20hood"
               onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;">
               <i class="fa fa-linkedin"></i>
               <span class="hidden">LinkedIn</span>
            </a>
        
    </div>
</footer>

        
    <div class="comments">
        <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "scovl-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="scovl" href="http://localhost:1313/">scovl</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2023 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                </p>
            </div>
        </footer>

        <script src="http://localhost:1313/js/jquery-1.11.3.min.js"></script>
        <script src="http://localhost:1313/js/jquery.fitvids.js"></script>
        <script src="http://localhost:1313/js/scripts.js"></script>
    </body>
</html>

